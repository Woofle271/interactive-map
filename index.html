<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  (function () {
    const APP_URL = "/app.html";

    function openLogin() {
      if (window.netlifyIdentity) window.netlifyIdentity.open();
    }

    function clearStoredAuth() {
      try {
        for (const k of Object.keys(localStorage)) {
          const s = k.toLowerCase();
          if (s.includes("gotrue") || s.includes("netlify") || s.includes("identity")) {
            localStorage.removeItem(k);
          }
        }
      } catch (e) {}
    }

    // Open after a short delay no matter what
    setTimeout(openLogin, 300);
    setTimeout(openLogin, 1000);

    if (!window.netlifyIdentity) return;

    window.netlifyIdentity.on("login", () => {
      window.location.replace(APP_URL);
    });

    window.netlifyIdentity.on("init", (user) => {
      if (user) window.netlifyIdentity.logout();
      clearStoredAuth();
      openLogin();
    });

    window.netlifyIdentity.init();
  })();
</script>
